# 目的

* 参照画像の特徴（または参照パッチ）に**似ている領域を対象画像内で可視化**し、粗いセグメントマスクと重畳表示を得る。

# 入出力

* 入力：参照画像`I_ref`（カーソル上のpaddingを参照）、対象画像`I_tgt`
* 出力：ヒートマップ`H`、粗マスク`M`、オーバーレイ画像`O`、（任意で）検出BBox

# パイプライン（最短コース）

1. **前処理**：`I_ref, I_tgt`をViTの解像度にリサイズ（例 518/518）、正規化。
2. **パッチ埋め込み**（DINOv3 ViT）：

   * パッチサイズ`p`（例16: モデルのチェックポイントによる）でトークン化し、L2正規化済みの埋め込み`E_ref∈R^{H_r×W_r×D}`、`E_tgt∈R^{H_t×W_t×D}`を取得。
   * 参照側はROI/クリック周辺パッチを**平均（prototype）**して`q∈R^D`を作る（未指定なら参照画像の上位salientパッチTop-Kを平均）。
3. **相互類似**：`H = cos_sim(q, E_tgt)`を各パッチ位置で計算→`H∈R^{H_t×W_t}`。
4. **平滑＆正規化**：ガウシアン/ボックスで軽く平滑、min-maxで[0,1]へ。
5. **粗マスク生成**：しきい値`τ`（Otsu or 上位Percentile, 例95%）で二値化→モルフォロジ（開閉）→最大連結成分抽出で`M`。
6. **オーバーレイ**：`H, M`を元解像度へアップサンプルし、`O = α*ColorMap(H) + (1-α)*I_tgt`（例`α=0.45`）。BBoxは`M`の外接矩形。

# 主要ハイパラ（最初の当たり値）

* ViT：`dinov3_vits14`（精度↑なら`vitb14`）
* パッチサイズ`p=16`、多層特徴は**最後層+中間層の加重和**（例 最後:0.7/中間:0.3）
* プロトタイプ：クリック半径`r=1~2`パッチ、またはTop-K=20パッチ平均
* しきい値：`τ=percentile(H, 95)`、モルフォ核`k=3~5`
* マルチスケール：参照/対象を倍率{0.75,1.0,1.25}で実行し**max融合**（頑健性↑）

# 最小疑似コード（PyTorchイメージ）

```python
E_ref = dinov3_embed(I_ref)    # [Hr,Wr,D], L2-norm済
E_tgt = dinov3_embed(I_tgt)    # [Ht,Wt,D]
q = prototype(E_ref, roi=optional)  # [D], 参照パッチ平均
H = (E_tgt @ q)                # 余弦類似（E_tgtは各位置で[D]）
H = smooth(minmax(H))
tau = percentile(H, 95)
M = morph(open_close(binarize(H, tau)))
O = overlay(I_tgt, H, M, alpha=0.45)
return H, M, O, bbox(M)
```

# DINOv3の使用方法
* `dinov3_demo.py`を参照。
* Hugging Faceベースでモデル利用

# 発展オプション（必要なときだけ）

* **自己類似**（1枚で物体性マップ）：各パッチと全パッチの類似平均→サリエンシ。
* **CRF/GrabCutで境界精緻化**、**Dense-CRF**やエッジ誘導で輪郭改善。
* **プロンプト画像を複数**→複数`q`のmaxまたは平均。

